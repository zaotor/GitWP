!function(){"use strict";var t=null;window.Windows&&window.Windows.UI&&window.Windows.UI.ViewManagement&&window.Windows.UI.ViewManagement.ApplicationView&&(t=window.Windows.UI.ViewManagement.ApplicationView);var e=WinJS.Navigation,i=function(t){return WinJSContrib.UI.Animation.pageExit(t)},n=function(t){return WinJS.UI.Animation.enterPage(t)};WinJS.Namespace.define("WinJSContrib.UI",{parentNavigator:function(t){for(var e=t.parentNode;e;){if(e.mcnNavigator)return e.winControl;e=e.parentNode}},PageControlNavigator:WinJS.Class.mix(WinJS.Class.define(function(a,o){var o=o||{};this._element=a||document.createElement("div"),this._element.winControl=this,this._element.mcnNavigator=!0,this._element.classList.add("mcn-navigator"),this.eventTracker=new WinJSContrib.UI.EventTracker,this.delay=o.delay||0,this.animationWaitForPreviousPageClose=o.animationWaitForPreviousPageClose||!0,this.animations={},this.locks=0,o.enterPageAnimation&&(this.animations.enterPage=WinJSContrib.Utils.resolveMethod(a,o.enterPageAnimation)),this.animations.enterPage||(this.animations.enterPage=n),o.exitPageAnimation&&(this.animations.exitPage=WinJSContrib.Utils.resolveMethod(a,o.exitPageAnimation)),this.animations.exitPage||(this.animations.exitPage=i),this.home=o.home,t&&(this._lastViewstate=t.value),this.global=void 0!==o.global?o.global:!0,this.global?(document.body.onkeyup=this._keyupHandler.bind(this),document.body.onkeypress=this._keypressHandler.bind(this),document.body.onmspointerup=this._mspointerupHandler.bind(this),WinJSContrib.UI.Application=WinJSContrib.UI.Application||{},WinJSContrib.UI.Application.navigator=this,this.eventTracker.addEvent(e,"beforenavigate",this._beforeNavigate.bind(this)),this.eventTracker.addEvent(e,"navigated",this._navigated.bind(this))):this.history={backstack:[]},this.eventTracker.addEvent(window,"resize",this._resized.bind(this))},{home:"",_element:null,_lastNavigationPromise:WinJS.Promise.as(),_lastViewstate:0,pageControl:{get:function(){return this.pageElement?this.pageElement.winControl:null}},pageElement:{get:function(){return this._pageElement||this._element.lastElementChild}},addLock:function(){this.locks++},removeLock:function(){this.locks--},_createPageElement:function(){var t=document.createElement("div");return t.setAttribute("dir",window.getComputedStyle(this._element,null).direction),t},dispose:function(){this._disposed||(this._disposed=!0,WinJS.Utilities.disposeSubTree&&WinJS.Utilities.disposeSubTree(this._element),this.eventTracker.dispose())},_getAnimationElements:function(t){return this.pageControl&&this.pageControl.getAnimationElements?this.pageControl.getAnimationElements(t):this.pageElement},_keypressHandler:function(t){"Backspace"===t.key&&e.back()},_keyupHandler:function(t){"Left"===t.key&&t.altKey||"BrowserBack"===t.key?e.back():("Right"===t.key&&t.altKey||"BrowserForward"===t.key)&&e.forward()},_mspointerupHandler:function(t){3===t.button?e.back():4===t.button&&e.forward()},navigate:function(t,e,i,n){var a=this;if(this.global)return WinJS.Navigation.navigate(t,e);var o={skipHistory:i,detail:{location:t,state:e,setPromise:function(t){this.pagePromise=t}}};return a._beforeNavigate(o),o.detail.pagePromise=o.detail.pagePromise||WinJS.Promise.wrap(),o.detail.pagePromise.then(function(){return n&&a.history.backstack.splice(a.history.backstack.length-1,1),a._navigated(o),o.detail.pagePromise})},clearHistory:function(){this.global?WinJS.Navigation.history.backStack=[]:this.history.backstack=[]},clear:function(){this.clearHistory(),this._pageElement=null,this._element.innerHTML=""},open:function(t,e){return this.navigate(t,e)},pick:function(t,e){return e=e||{},e.navigateStacked=!0,this.navigate(t,e)},canGoBack:{get:function(){return this.global?e.canGoBack:this.history.backstack.length>0}},back:function(t){var e=this;if(e.global)return WinJS.Navigation.back(t);if(e.history.backstack.length){var i=e.history.backstack.length-1,n=e.history.backstack[i];return e.navigate(n.location,n.state,!0,!0)}},_beforeNavigate:function(t){var e=this,i=this.pageElement;t.detail.state=t.detail.state||{};var n=1==e.stackNavigation||t.detail.state.navigateStacked;if(this.locks>0){var a=new WinJS.Promise(function(){});return t.detail.setPromise(a),void a.cancel()}if(i&&i.winControl&&i.winControl.canClose){var o=null,a=new WinJS.Promise(function(t){o=t});return setImmediate(function(){WinJS.Promise.wrap(i.winControl.canClose()).then(function(t){t?(e.triggerPageExit(),o()):a.cancel()})}),void t.detail.setPromise(a)}(!n||t.detail.state.mcnNavigationDetails)&&e.triggerPageExit()},triggerPageExit:function(){var t=this,e=this.pageElement;if(e&&e.winControl&&!e.winControl.exitPagePromise){if(e.winControl.exitPagePromise=WinJS.Promise.as(e.winControl.exitPageAnimation?e.winControl.exitPageAnimation:t.animations.exitPage(t._getAnimationElements(!0))),e.winControl.exitPagePromise=e.winControl.exitPagePromise.then(function(){return e.style.display="none",WinJS.Promise.timeout()}),e.winControl.exitPage){var i=e.winControl.exitPage();if(i){var n=WinJS.Promise.as(i),a=e.winControl.exitPagePromise;e.winControl.exitPagePromise=n.then(function(){return a})}}var o=e.querySelectorAll(".mcn-layout-ctrl");if(o&&o.length)for(var r=0;r<o.length;r++){var s=o[r].winControl;s.exitPage&&s.exitPage()}WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.show()}},closePage:function(t,e){var i=this;e=e||{};var n=(i._element,t||this.pageElement);n&&$(".tap",n).untap();var a=n&&n.winControl&&n.winControl.exitPagePromise?n.winControl.exitPagePromise:WinJS.Promise.wrap();return i.dispatchEvent("closingPage",{page:n}),n&&n.winControl&&(n.winControl.dispatchEvent("closing",{youpla:"boom"}),n.winControl.cancelPromises&&n.winControl.cancelPromises()),!i.global&&n&&n.winControl&&n.winControl.navigationState&&!e.skipHistory&&i.history.backstack.push(n.winControl.navigationState),i._pageElement=null,a.then(function(){if(n){n.style.opacity="0",n.style.display="none",n.winControl&&(n.winControl.stackedOn=null,n.winControl.stackedBy=null,n.winControl.eventTracker&&n.winControl.eventTracker.dispose(),n.winControl.unload&&n.winControl.unload()),WinJS.Utilities.disposeSubTree&&WinJS.Utilities.disposeSubTree(n);try{$(n).remove()}catch(t){console.log("cannot remove page, WTF ????????")}}})},_navigated:function(t){var e=this;t.detail.state=t.detail.state||{};var i=e._element,n=this.pageControl,a=this.pageElement,o=1==e.stackNavigation||t.detail.state&&t.detail.state.navigateStacked;if(this._lastNavigationPromise&&(this._lastNavigationPromise.cancel(),WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.hide()),n&&n.stackedOn&&t.detail.state.mcnNavigationDetails){var r=e.closePage(a,t);return this._lastNavigationPromise=r,t.detail.setPromise(r),void(WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.hide())}if(o){!e.global&&a&&a.winControl&&a.winControl.navigationState&&!t.skipHistory&&e.history.backstack.push(a.winControl.navigationState);var r=WinJS.Promise.wrap()}else var r=e.closePage(a,t);t.detail.state.mcnNavigationDetails={id:WinJSContrib.Utils.guid(),date:new Date};{var s;new WinJS.Promise(function(t){s=t})}if(e.animationWaitForPreviousPageClose)var l=r.then(function(){return WinJS.Promise.timeout(e.delay)});else var l=WinJS.Promise.timeout(e.delay);e.currentPageDetails=t.detail;var c=WinJSContrib.UI.renderFragment(i,t.detail.location,t.detail.state,{delay:l,enterPage:e.animations.enterPage,closeOldPagePromise:r,onfragmentinit:function(t){t.element.mcnPage=!0,o&&(t.stackedOn=n,n&&(n.stackedBy=t))},onafterlayout:function(i){t.detail.state&&t.detail.state.clearNavigationHistory&&(e.global?WinJS.Navigation.history.backStack=[]:e.history.backstack=[]),e._updateBackButton(i)},onafterready:function(){WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.hide()}}).then(function(){e._lastNavigationPromise=void 0});this._lastNavigationPromise=c,t.detail.setPromise(WinJS.Promise.join([r,c]))},_resized:function(){if(this.pageControl&&this.pageControl.element){var e=this;e.pageControl.element.opacity="0",setImmediate(function(){var i=t?t.value:null;e.pageControl.updateLayout&&e.pageControl.updateLayout.call(e.pageControl,e.pageElement,i,e._lastViewstate);var n=e.pageControl.element.querySelectorAll(".mcn-layout-ctrl");if(n&&n.length)for(var a=0;a<n.length;a++){var o=n[a].winControl;o.updateLayout&&o.updateLayout(o.element,i,e._lastViewstate)}WinJS.UI.Animation.fadeIn(e.pageControl.element)})}this._lastViewstate=t?t.value:null},_handleBack:function(){e.back()},_updateBackButton:function(t){var i=this,n=$(".win-backbutton",t.element);if(n&&n.length>0){n.click(function(t){if(i.global)e.back();else{var n=WinJSContrib.UI.parentNavigator(t.currentTarget);n.back()}});var a=!1;i.canGoBack&&!a?n.removeAttr("disabled"):n.attr("disabled","disabled")}}}),WinJS.Utilities.eventMixin)})}();